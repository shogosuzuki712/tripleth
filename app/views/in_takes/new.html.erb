
<%= render "shared/header"%> <%#=== „Éò„ÉÉ„ÉÄ„ÉºË™≠„ÅøËæº„Åø %>

<div class="record-new">
  <%# ------- „Éö„Éº„Ç∏Â∑¶ÂÅ¥ -------- %>
  <div class="record-left">

    <%# ------- „Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫ --------- %>
    <div class="record-calendar">
      <%= month_calendar events: @in_takes do |date, in_takes| %>
        <%= date.day %>
        <% in_takes.each do |in_take| %>
          <%# „ÄÇÔºä„ÄÇÔºä ActiveHash„Åã„ÇâÂØæÂøú„Åô„Çã„Ç´„É≠„É™„Éº„ÇíË°®Á§∫ „ÄÇÔºä„ÄÇÔºä#%>
          <%= render partial: "calender_cal", locals: {in_take: in_take} %>
          <%# „ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇ#%>
        <% end %>
      <% end %>
    </div>
    <%# ------- „Ç´„É¨„É≥„ÉÄ„Éº„Åì„Åì„Åæ„Åß ------ %>


    <%# --------- „Ç∞„É©„ÉïË°®Á§∫ ----------- %>
    <div class="record-graph">
      <% array = [] %> <%#=== Á©∫„ÅÆÈÖçÂàó %>
      <% @in_takes.each do |in_take| %>
        
        <% if array.length != 0 %>
          <% i=0 %>
          <% e=0 %>
          <% array.length.times do |i| %> 
            
            <% if array[i][:start_time] == in_take.start_time %>
              <%# „ÄÇÔºä„ÄÇÔºä ÈÖçÂàó„Å´ÂêåÂÄ§„ÅÆ :start_time „ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÄÅ„Ç´„É≠„É™„ÉºÂÄ§„ÇíÂêàÁÆó „ÄÇÔºä„ÄÇÔºä#%>
              <% render partial: "day_cal_add", locals: {in_take: in_take, array: array, i: i} %>
              <%# „ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä „ÄÇ#%>
            <% else %> <%#== ‰∏ÄËá¥„Åô„Çã:start_time„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà %>
              
              <% i += 1 %>
              <% e += 1 %> <%#== ‰∏ÄËá¥„Åó„Å™„ÅÑ„Å®e„ÅÆÂÄ§„ÅåÂ¢ó„Åà„Çã‰ªïÁµÑ„Åø %>

              <% if e == array.length %> <%#== ÂÖ®„Å¶‰∏ÄËá¥„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÄÅÊñ∞„Åó„ÅèÈÖçÂàó„Å´ÂÄ§(„Éè„ÉÉ„Ç∑„É•)„ÅåÂÖ•„Çã %>
                <%# „ÄÇÔºä„ÄÇÔºä ÈÖçÂàó„Å´Êñ∞Ë¶èÁôªÈå≤ „ÄÇÔºä„ÄÇÔºä#%>
                <% render partial: "day_cal_new", locals: {in_take: in_take, array: array} %>
                <%# „ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä#%>
              <% end %> 
            <% end %> <%#=== (end of "if array[i][:start_time] == in_take.start_time") %>
          <% end %> <%#=== (end of "array.length.times do |i|") %> 

        <% else %> <%#=== array„ÅåÁ©∫„ÅÆÂ†¥Âêà (else of "if array.length != 0") %>
          <%# „ÄÇÔºä„ÄÇÔºä ÈÖçÂàó„Å´Êñ∞Ë¶èÁôªÈå≤ „ÄÇÔºä„ÄÇÔºä#%>
          <% render partial: "day_cal_new", locals: {in_take: in_take, array: array} %>
          <%# „ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä#%>
        <% end %>
      <% end %> <%#=== end of "@in_takes.each do |in_take|" %>


      <%# __________ÈÖçÂàó„ÇíÊôÇÈñì„Åî„Å®„Åß„ÅØ„Å™„Åè„ÄÅÊó•‰ªò„Åî„Å®„Å´„Åæ„Å®„ÇÅ„Çã___________ %>
      <% @day_cal = array.group_by_day{|i| i[:start_time]} %>

      <%# ______________________„Ç∞„É©„Éï„Å´Ë°®Á§∫________________________ %>
      <%= line_chart @day_cal.map{|k,v| [k, v.sum{|hash| hash[:food_cal]}]} %>
    
    </div>
    <%# ------- „Ç∞„É©„Éï„Åì„Åì„Åæ„Åß ------ %>
  </div>
  <%# ------- „Éö„Éº„Ç∏Â∑¶ÂÅ¥„Åì„Åì„Åæ„Åß ------ %>



  <%# ------- „Éö„Éº„Ç∏Âè≥ÂÅ¥ -------- %>
  <div class="record-right">
    <div class="record-title" >in_takes</div>

    <%# -------- „Åì„Åì„Åã„ÇâÁôªÈå≤„Éï„Ç©„Éº„É† -------- %>
    <%= form_with model: @in_take, url: in_takes_path(current_user.id), local: true do |f| %>
    
      <%# ------- „Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Ç®„É©„ÉºÊñá --------- %>
      <% if @in_take.errors.any? %>
        <div class="in-takes-error-alert">
          <ul>
            <% @in_take.errors.full_messages.each do |message| %>
              <li class='in-takes-error-message'><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <%# ------- „Ç®„É©„ÉºÊñá„Åì„Åì„Åæ„Åß --------- %>

      <div class="record-form">
        <div class="record-data" >
          <%= f.datetime_select :start_time %> <%#=== Êó•‰ªòÈÅ∏Êäû %>
        </div>

        <%#„ÄÇÔºä„ÄÇÔºä È£ü„Åπ„ÅüÈ£ü‰∫ã„Éª„Åù„ÅÆ„Ç´„É≠„É™„Éº„ÇíÈÅ∏Êäû„Åß„Åç„Çã„Éï„Ç©„Éº„É† „ÄÇÔºä„ÄÇÔºä %>
        <%= render "form" %>
        <%#„ÄÇÔºä„ÄÇÔºä „ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇÔºä„ÄÇ%>
        
        <button type="button" id="add-form">ËøΩÂä†„Åô„Çã</button> <%#=== ËøΩÂä†„Åô„Çã„Éú„Çø„É≥(type=button„Çí‰∏é„Åà„Å™„ÅÑ„Å®submit„Åï„Çå„Å¶„Åó„Åæ„ÅÜ) %>
        

          <%#_________üî•_________ËøΩÂä†„Åô„Çã„Éú„Çø„É≥„Åß‰ª•‰∏ã„ÅÆ„Çπ„ÇØ„É™„Éó„ÉàÁô∫ÁÅ´___________üî•__________%>

          <%#<<<<<<<<<<<< Âêå„ÅòÈÉ®ÂàÜ„Éï„Ç©„Éº„É†„ÇíËøΩÂä†„Åô„ÇãJavaScript 
                          Ruby„ÅÆ„Ç≥„Éº„Éâ„Çí‰ΩøÁî®„Åó„Åü„ÅÑ„Åü„ÇÅ„Åì„Å°„Çâ„Å´Ë®òËø∞ >>>>>>>>>>>>>>>%>
          <script>
            const addForm = document.getElementById("add-form");
            addForm.addEventListener("click", ()=>{
              const insertHtml = "<%= escape_javascript(render "form") %>"; //ËøΩÂä†„Åô„Çãhtml.erb
              const inTakesForm = document.getElementsByClassName("in-takes-form"); //ÊäïÁ®ø„Éï„Ç©„Éº„É†
              inTakesForm[inTakesForm.length - 1].insertAdjacentHTML("afterend", insertHtml);
            });
          </script>
          <%#<<<<<<<<<<<< „Åì„Åì„Åæ„Åß >>>>>>>>>>>>>>>%>


        <%#-------- ÂêàË®à„Ç´„É≠„É™„ÉºÂÄ§„ÅÆË°®Á§∫ ---------%>
        <div class="record-menu">ÂêàË®à <span id="sum-cal">0</span> kcal </div>

        <%#-------- ÁôªÈå≤„Éú„Çø„É≥ ---------%>
        <div class="record-input" >
          <%= f.submit "ÁôªÈå≤„Éú„Çø„É≥", id:"in-takes-submit" %>
        </div>
      </div> 
    <% end %>
    <%#-------- ÁôªÈå≤„Éï„Ç©„Éº„É†„Åì„Åì„Åæ„Åß ---------%>
  </div>
  <%#-------- „Éö„Éº„Ç∏Âè≥ÂÅ¥„Åì„Åì„Åæ„Åß ---------%>
</div>